workflows:
  android-apk:
    name: Build SuppliesTracker APK
    instance_type: mac_mini_m1
    max_build_duration: 60
    scripts:
      - name: Setup and Install
        script: |
          # 1. Config Java 11 (la plus stable pour RN 0.72)
          sdk use java 11.0.19-sem || true
          
          # 2. Préparation du code JS
          cp "App (1).js" App.js || true
          npm install --quiet

          # 3. Structure Android complète
          mkdir -p android/app/src/main/java/com/suppliestracker
          mkdir -p android/app/src/main/res/values
          mkdir -p android/app/src/main/assets

          # 4. Fichiers de configuration
          echo "rootProject.name = 'SuppliesTracker'" > android/settings.gradle
          echo "include ':app'" >> android/settings.gradle

          cat <<EOF > android/build.gradle
          buildscript {
              repositories { google(); mavenCentral() }
              dependencies { classpath("com.android.tools.build:gradle:7.4.2") }
          }
          allprojects {
              repositories {
                  google()
                  mavenCentral()
                  maven { url "$CM_BUILD_DIR/node_modules/react-native/android" }
              }
          }
          EOF

          # 5. Build.gradle App (Optimisé pour la mémoire)
          cat <<EOF > android/app/build.gradle
          apply plugin: "com.android.application"
          android {
              namespace "com.suppliestracker"
              compileSdkVersion 33
              defaultConfig {
                  applicationId "com.suppliestracker"
                  minSdkVersion 21
                  targetSdkVersion 33
                  versionCode 1
                  versionName "1.0"
                  multiDexEnabled true
              }
              dexOptions {
                  javaMaxHeapSize "2g"
              }
              packagingOptions {
                  pickFirst '**/libc++_shared.so'
                  pickFirst '**/libfbjni.so'
                  exclude 'META-INF/DEPENDENCIES'
              }
          }
          dependencies {
              implementation "com.facebook.react:react-android:0.72.6"
              implementation "com.facebook.react:hermes-android:0.72.6"
              implementation "androidx.appcompat:appcompat:1.4.1"
              implementation "androidx.multidex:multidex:2.0.1"
          }
          EOF

          # 6. Fichiers Java Indispensables
          cat <<EOF > android/app/src/main/java/com/suppliestracker/MainActivity.java
          package com.suppliestracker;
          import com.facebook.react.ReactActivity;
          public class MainActivity extends ReactActivity {
            @Override
            protected String getMainComponentName() { return "SuppliesTracker"; }
          }
          EOF

          cat <<EOF > android/app/src/main/java/com/suppliestracker/MainApplication.java
          package com.suppliestracker;
          import android.app.Application;
          import com.facebook.react.ReactApplication;
          import com.facebook.react.ReactNativeHost;
          import com.facebook.react.ReactPackage;
          import com.facebook.react.shell.MainReactPackage;
          import com.facebook.soloader.SoLoader;
          import java.util.Arrays;
          import java.util.List;
          public class MainApplication extends Application implements ReactApplication {
            private final ReactNativeHost mReactNativeHost = new ReactNativeHost(this) {
              @Override
              public boolean getUseDeveloperSupport() { return false; }
              @Override
              protected List<ReactPackage> getPackages() { return Arrays.<ReactPackage>asList(new MainReactPackage()); }
              @Override
              protected String getJSMainModuleName() { return "index"; }
            };
            @Override
            public ReactNativeHost getReactNativeHost() { return mReactNativeHost; }
            @Override
            public void onCreate() { super.onCreate(); SoLoader.init(this, false); }
          }
          EOF

          # 7. Manifest
          cat <<EOF > android/app/src/main/AndroidManifest.xml
          <manifest xmlns:android="http://schemas.android.com/apk/res/android" package="com.suppliestracker">
              <uses-permission android:name="android.permission.INTERNET" />
              <application android:name=".MainApplication" android:label="SuppliesTracker" android:theme="@style/Theme.AppCompat.Light.NoActionBar">
                  <activity android:name=".MainActivity" android:exported="true">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>
              </application>
          </manifest>
          EOF

      - name: Bundle JS
        script: |
          npx react-native bundle --platform android --dev false --entry-file App.js \
            --bundle-output android/app/src/main/assets/index.android.bundle \
            --assets-dest android/app/src/main/res

      - name: Build APK
        script: |
          cd android
          gradle wrapper --gradle-version 7.5
          chmod +x gradlew
          # On limite la mémoire JVM pour éviter que le système ne tue le processus
          export GRADLE_OPTS="-Dorg.gradle.jvmargs='-Xmx2048m -XX:MaxMetaspaceSize=512m'"
          ./gradlew assembleDebug --no-daemon
          
    artifacts:
      - android/app/build/outputs/apk/debug/*.apk
    publishing:
      email:
        recipients:
          - ton-email@exemple.com
