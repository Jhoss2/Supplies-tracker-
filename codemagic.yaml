workflows:
  android-apk:
    name: Build SuppliesTracker APK
    instance_type: mac_mini_m1
    max_build_duration: 60
    scripts:
      - name: Build and Package APK
        script: |
          # 1. Initialisation
          sdk use java 17.0.7-sem || true
          cp "App (1).js" App.js || true
          
          cat <<EOF > index.js
          import {AppRegistry} from 'react-native';
          import App from './App';
          AppRegistry.registerComponent('SuppliesTracker', () => App);
          EOF

          npm install --quiet

          # --- ÉTAPE CRUCIALE : PATCH DE LA BIBLIOTHÈQUE SQLITE ---
          # On injecte 'checkManifest true' dans le build.gradle de SQLite pour satisfaire Gradle 7+
          SQLITE_GRADLE="node_modules/react-native-sqlite-storage/src/android/build.gradle"
          if [ -f "$SQLITE_GRADLE" ]; then
            sed -i '' 's/android {/android {\n    publishNonDefault true/' "$SQLITE_GRADLE" || true
          fi
          # -------------------------------------------------------

          # 2. Structure Android
          rm -rf android
          mkdir -p android/app/src/main/java/com/suppliestracker/android/app/src/main/res/values/android/app/src/main/assets
          mkdir -p android/app/src/main/java/com/suppliestracker
          mkdir -p android/app/src/main/res/values
          mkdir -p android/app/src/main/assets

          echo "rootProject.name = 'SuppliesTracker'" > android/settings.gradle
          echo "include ':app'" >> android/settings.gradle
          echo "include ':react-native-sqlite-storage'" >> android/settings.gradle
          echo "project(':react-native-sqlite-storage').projectDir = new File(rootProject.projectDir, '../node_modules/react-native-sqlite-storage/src/android')" >> android/settings.gradle

          cat <<EOF > android/gradle.properties
          android.useAndroidX=true
          android.enableJetifier=true
          EOF

          cat <<EOF > android/build.gradle
          buildscript {
              repositories { google(); mavenCentral() }
              dependencies { classpath("com.android.tools.build:gradle:7.4.2") }
          }
          allprojects {
              repositories { 
                  google()
                  mavenCentral()
                  maven { url "\$projectDir/../node_modules/react-native/android" } 
              }
          }
          EOF

          cat <<EOF > android/app/build.gradle
          apply plugin: "com.android.application"
          android {
              namespace "com.suppliestracker"
              compileSdkVersion 33
              defaultConfig {
                  applicationId "com.suppliestracker"
                  minSdkVersion 21
                  targetSdkVersion 33
                  versionCode 1
                  versionName "1.0"
                  multiDexEnabled true
              }
              buildTypes {
                  debug {
                      matchingFallbacks = ['release']
                  }
              }
          }
          dependencies {
              implementation "com.facebook.react:react-android:0.72.6"
              implementation "com.facebook.react:hermes-android:0.72.6"
              implementation project(':react-native-sqlite-storage')
              implementation "androidx.appcompat:appcompat:1.4.1"
              implementation "androidx.multidex:multidex:2.0.1"
          }
          EOF

          cat <<EOF > android/app/src/main/java/com/suppliestracker/MainActivity.java
          package com.suppliestracker;
          import com.facebook.react.ReactActivity;
          public class MainActivity extends ReactActivity {
            @Override protected String getMainComponentName() { return "SuppliesTracker"; }
          }
          EOF

          cat <<EOF > android/app/src/main/java/com/suppliestracker/MainApplication.java
          package com.suppliestracker;
          import android.app.Application;
          import androidx.multidex.MultiDexApplication;
